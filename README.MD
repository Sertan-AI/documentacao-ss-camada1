# Contrato de Dados: Camada 1 â†’ Camada 2

<div align="center">

**VersÃ£o:** V0  
**Status:** âœ… ConcluÃ­do, aguardando validaÃ§Ã£o  
**ResponsÃ¡vel:** Samuel Santos (Camada 1)  
**Consumidores diretos:** Camada 2 XAI / SHAP, Backend-hub

---

</div>

## ğŸ¯ Objetivo deste documento

Este documento define o **contrato tÃ©cnico mÃ­nimo, explÃ­cito e auditÃ¡vel** entre:

- **Camada 1 â€” Monitoramento de Campo**
- **Camada 2 â€” XAI / SHAP / InteligÃªncia Artificial**

Ele responde de forma **inequÃ­voca**:

- âœ“ O que a Camada 1 **entrega como dado**
- âœ“ **Quando** esses dados estÃ£o prontos para consumo
- âœ“ **Em que formato** e com **quais garantias tÃ©cnicas**
- âœ“ O que **nÃ£o Ã© responsabilidade** da Camada 1 no MVP

> [!IMPORTANT]
> Este contrato existe para **eliminar ambiguidade**, **evitar dependÃªncias implÃ­citas** e **destravar a Camada 2 com seguranÃ§a**.

---

## ğŸ“¥ Evento de Disparo (Trigger)

### ğŸ§  Trigger LÃ³gico (Produto)

A Camada 2 **pode rodar apenas quando**:

- â˜‘ï¸ O usuÃ¡rio **finaliza a sessÃ£o de monitoramento**
- â˜‘ï¸ O usuÃ¡rio **edita uma sessÃ£o existente**
- â˜‘ï¸ O usuÃ¡rio **insere uma nova sessÃ£o**

> [!NOTE]
> Nenhum outro evento Ã© vÃ¡lido no V0.

---

### âš™ï¸ Trigger TÃ©cnico (Contrato)

EvidÃªncia objetiva no banco que confirma o disparo:

```sql
monitor_sessao.status = 'concluida'
```

<div align="center">

| **EvidÃªncia no Banco de Dados** | **EvidÃªncia na Interface** |
|:-------------------------------:|:--------------------------:|
| ![Banco de Dados](static/demo/trigger_banco.png) | ![Interface](static/demo/trigger_interface.png) |

</div>

> [!WARNING]
> SessÃµes nÃ£o finalizadas **nÃ£o** disparam processamento.

ğŸ“Œ NÃ£o existem triggers alternativos no V0 (cron, timeout, upload, etc.).

---

## ğŸ—ºï¸ Estrutura de Dados Contratada

### 1ï¸âƒ£ Geometria da SessÃ£o

<table>
<tr>
<td><strong>Tipo</strong></td>
<td><code>geometry</code> (PostGIS)</td>
</tr>
<tr>
<td><strong>Subtipo esperado</strong></td>
<td><code>Polygon</code> ou <code>MultiPolygon</code></td>
</tr>
<tr>
<td><strong>SRID</strong></td>
<td><code>4326</code></td>
</tr>
<tr>
<td><strong>Origem da geometria</strong></td>
<td>Ãreas definidas como zonas crÃ­ticas com base no NDVI, para o perÃ­odo especificado, utilizando imagens Sentinel-2</td>
</tr>
</table>

#### ğŸ“Š ValidaÃ§Ã£o do SRID no Banco de Dados

Consulta realizada para validaÃ§Ã£o:

```sql
SELECT
    f_table_schema      AS schema,
    f_table_name        AS tabela,
    f_geometry_column   AS coluna_geom,
    type                AS tipo_geometria,
    coord_dimension     AS dimensao,
    srid
FROM public.geometry_columns
WHERE f_table_name IN (
    'monitor_obs_daninha',
    'monitor_obs_deficiencia',
    'monitor_obs_doenca',
    'monitor_obs_praga',
    'monitor_ponto',
    'monitor_rota',
    'monitor_sessao',
    'monitor_zona',
    'diagnostico'
)
ORDER BY f_table_name;
```

**Resultado da consulta:**

| Schema | Tabela | Coluna Geom | Tipo Geometria | DimensÃ£o | SRID |
|--------|--------|-------------|----------------|----------|------|
| formulario | diagnostico | geom | MULTIPOLYGON | 2 | **4326** |
| formulario | monitor_ponto | geom | POINT | 2 | **4326** |
| formulario | monitor_rota | geom | LINESTRING | 2 | **4326** |
| formulario | monitor_zona | geom | MULTIPOLYGON | 2 | **4326** |


<div align="center">

![Resultado da Consulta SRID](static/demo/consulta_srid.png)

*Resultado da consulta SQL para validaÃ§Ã£o do SRID*

</div>


#### ğŸ“ Tabelas Utilizadas

As seguintes tabelas sÃ£o utilizadas para compor a geometria da sessÃ£o:

- â˜‘ï¸ `monitor_zona` â€” Zonas crÃ­ticas detectadas
- â˜‘ï¸ `monitor_rota` â€” Rotas percorridas durante o monitoramento
- â˜‘ï¸ `monitor_ponto` â€” Pontos de observaÃ§Ã£o em campo

---

### âœ… Garantias da Geometria

A Camada 1 garante que:

- âœ“ `ST_IsValid(geometry) = true`
- âœ“ Geometria sem buracos invÃ¡lidos (a geometria Ã© poligonizada a partir de pixels de imagem Sentinel-2; erros topolÃ³gicos sÃ£o raros e nÃ£o impedem o funcionamento de sistemas Python que as coletam e tratam)
- âœ“ Geometria representa apenas a Ã¡rea monitorada
- âœ“ Geometria Ã© recuperÃ¡vel para leitura e exportaÃ§Ã£o

> [!IMPORTANT]
> A Camada 2 **assume esta geometria como verdade espacial**.

<div align="center">

![VisualizaÃ§Ã£o da Geometria](demo/geometria_visualizacao.png)

*Exemplo de geometria de zona crÃ­tica renderizada no sistema*

</div>

<div align="center">

| **EvidÃªncia no Banco de Dados** | **EvidÃªncia na Interface** |
|:-------------------------------:|:--------------------------:|
| <img src="static/demo/evid_demo_banco.png" alt="Banco de Dados" style="height: 300px; width: auto; object-fit: contain;"> | <img src="static/demo/evid_demo_interface.png" alt="Interface" style="height: 300px; width: auto; object-fit: contain;"> |

</div>

---

### 2ï¸âƒ£ ObservaÃ§Ãµes de Campo

Cada observaÃ§Ã£o possui:

| Campo | Tipo | ObrigatÃ³rio | ObservaÃ§Ãµes |
|-------|------|:-----------:|-------------|
| `sessao_id` | int | âœ… | FK para `monitor_sessao` |
| `tipo` | enum | âœ… | `praga` \| `doenÃ§a` \| `daninha` \| `deficiÃªncia` |
| `severidade` | enum | âœ… | `baixa` \| `moderada` \| `alta` |
| `timestamp` | timestamp | âœ… | Momento da observaÃ§Ã£o |
| `nota` | text | âŒ | Texto livre |
| `foto` | text/path | âŒ | EvidÃªncia bruta |

> [!NOTE]
> **Fotos nÃ£o sÃ£o interpretadas no MVP.**  
> SÃ£o armazenadas apenas como evidÃªncia, sem uso analÃ­tico.

---

### ğŸ”¢ Cardinalidade (Contrato ExplÃ­cito)

```mermaid
erDiagram
    MONITOR_SESSAO ||--o{ MONITOR_PONTO : "possui N pontos"
    MONITOR_PONTO ||--o{ OBSERVACAO : "possui 0..N observaÃ§Ãµes"
    
    MONITOR_SESSAO {
        int id
        string status
        geometry geom
    }
    
    MONITOR_PONTO {
        int id
        int sessao_id
        geometry geom
    }
    
    OBSERVACAO {
        int id
        int ponto_id
        enum tipo
        enum severidade
        timestamp timestamp
    }
```

**Regras de cardinalidade:**

- Uma sessÃ£o possui **N pontos**  
  *A quantidade de pontos depende do tamanho da zona crÃ­tica detectada para o perÃ­odo analisado*

- Um ponto pode possuir **0..N observaÃ§Ãµes**  
  *A quantidade de observaÃ§Ãµes varia de acordo com as ocorrÃªncias reais observadas em campo, podendo ser uma ou mais por ponto*

- Cada observaÃ§Ã£o pertence a **exatamente um ponto**  
  *Cada observaÃ§Ã£o Ã© vinculada a um ponto. Nem todos os pontos sÃ£o obrigados a terem observaÃ§Ãµes*

> [!IMPORTANT]
> Esta cardinalidade Ã© **contrato conceitual e tÃ©cnico** para a Camada 2.

---

## ğŸŒ± VariÃ¡veis Ambientais

### Estado Atual (V0)

> [!WARNING]
> **NÃƒO fazem parte do contrato da Camada 1:**
> - NDVI
> - Chuva
> - Solo
> - Clima

ğŸ“Œ Estas variÃ¡veis **nÃ£o sÃ£o persistidas nem garantidas** pela Camada 1 no MVP.

> [!NOTE]
> A Camada 1 gera grÃ¡ficos dessas variÃ¡veis para o relatÃ³rio descritivo, mas o cÃ¡lculo de estatÃ­sticas usadas no modelo (mÃ©dia, mediana, moda) Ã© realizado diretamente na Camada 2 para maior eficiÃªncia, em vez de armazenar no banco.

ğŸ‘‰ Elas podem ser **derivadas posteriormente pela Camada 2**, a partir da geometria, via serviÃ§os externos (ex.: Google Earth Engine).

---

## ğŸ“¤ Formato de Entrega dos Dados

**Formato principal (V0):**

<div align="center">

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL / PostGIS Database     â”‚
â”‚                                     â”‚
â”‚   â”œâ”€â”€ monitor_sessao                â”‚
â”‚   â”œâ”€â”€ monitor_zona                  â”‚
â”‚   â”œâ”€â”€ monitor_ponto                 â”‚
â”‚   â”œâ”€â”€ monitor_rota                  â”‚
â”‚   â””â”€â”€ observaÃ§Ãµes*                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–²
              â”‚
         SQL / SQLAlchemy
              â”‚
         (Camada 2)
```

</div>

**Acesso:**

- â˜‘ï¸ Leitura direta via SQL (geralmente via SQLAlchemy em Python)

**Views:**

- Opcionais
- **NÃ£o obrigatÃ³rias** no V0

> [!CAUTION]
> Payload via API / funÃ§Ã£o **nÃ£o faz parte deste contrato**.

---

## âœ… Garantias do Contrato

<div align="center">

| Garantia | Status |
|----------|:------:|
| Dados persistidos no banco | âœ… |
| Geometria vÃ¡lida e consistente | âœ… |
| ObservaÃ§Ãµes seguem contrato mÃ­nimo | âœ… |
| HistÃ³rico por sessÃ£o recuperÃ¡vel | âœ… |

</div>

> [!IMPORTANT]
> Toda inferÃªncia, transformaÃ§Ã£o, cÃ¡lculo ou decisÃ£o analÃ­tica Ã© **responsabilidade exclusiva da Camada 2**.

---

## ğŸ§­ Limites ExplÃ­citos do Contrato (V0)

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">

### âš ï¸ Este contrato **NÃƒO cobre**:

<table style="width: 100%; background: rgba(255,255,255,0.1); border-radius: 8px;">
<tr>
<td style="padding: 10px;">

âŒ **InferÃªncia agronÃ´mica**  
*Nessa camada temos apenas descriÃ§Ã£o. A inferÃªncia fica para a Camada 2*

âŒ **AnÃ¡lise de imagem**  
*Cria mapas para o relatÃ³rio, mas sem anÃ¡lise inferencial*

âŒ **NDVI / clima / solo**  
*Cria mapas para o relatÃ³rio*

</td>
<td style="padding: 10px;">

âŒ **Scoring**  
*O banco possui catÃ¡logos de pesos e medidas para o modelo, a serem usados pela Camada 2*

âŒ **PriorizaÃ§Ã£o**  
*Responsabilidade da Camada 2*

âŒ **Explicabilidade (SHAP)**  
*Fica para a Camada 2*

âŒ **RelatÃ³rios ou PDFs**  
*A Camada 1 gera um relatÃ³rio inicial com mapas e grÃ¡ficos descritivos*

</td>
</tr>
</table>

</div>

> [!IMPORTANT]
> Qualquer item acima pertence Ã  Camada 2 ou camadas superiores, conforme explicado.

---

## ğŸ—ï¸ Nota de Arquitetura

Este contrato:

- âœ“ Ã‰ versionado (V0, V1, V2â€¦)
- âœ“ NÃ£o muda sem alinhamento explÃ­cito entre camadas
- âœ“ Protege o produto de deriva tÃ©cnica e escopo implÃ­cito
- âœ“ Ã‰ **prÃ©-requisito obrigatÃ³rio** para integraÃ§Ã£o da Camada 2

---

## âœ… Checklist de EvidÃªncias ObrigatÃ³rias (Aceite do Contrato)

> [!NOTE]
> Este checklist deve ser marcado pelo responsÃ¡vel da Camada 1.  
> Somente apÃ³s todos os itens estarem comprovados, o contrato pode ser considerado **aceito**.

### ğŸ” EvidÃªncias TÃ©cnicas

- [X] Existe evidÃªncia no banco de `monitor_sessao.status = 'concluida'` (Evidencia A)
- [X] A geometria associada Ã  sessÃ£o Ã© vÃ¡lida (`ST_IsValid = true`) (Evidencia B)
- [X] A geometria estÃ¡ no SRID 4326 (Evidencia B)
- [X] As observaÃ§Ãµes possuem FK vÃ¡lida para ponto e sessÃ£o (Evidencia C)
- [X] Campos obrigatÃ³rios sÃ£o garantidos:
	[X] tipo: garantido via UX (formulÃ¡rio sÃ³ abre apÃ³s seleÃ§Ã£o de categoria)
	[X] severidade: campo required no HTML + validaÃ§Ã£o backend (Evidencia D)
	[X] timestamp: gerado automaticamente com now() 
- [X] Cardinalidade ponto â†” observaÃ§Ã£o respeitada no banco (Evidencia E (csv e print)
- [X] SessÃ£o pode ser recuperada integralmente apÃ³s finalizaÃ§Ã£o (Evidencia F/G)
- [X] ExportaÃ§Ã£o/consulta da geometria funciona (SQL / GeoJSON / SHP) (Evidencia H/I)

#### ğŸ“¸ Galeria de EvidÃªncias

<div align="center">

| EvidÃªncia A | EvidÃªncia B | EvidÃªncia C | EvidÃªncia D |
|-------------|-------------|-------------|-------------|
| <a href="static/demo/evid_a.png" target="_blank"><img src="static/demo/evid_a.png" style="width: 100px;"></a> | <a href="static/demo/evid_b.png" target="_blank"><img src="static/demo/evid_b.png" style="width: 100px;"></a> | <a href="static/demo/evid_c.png" target="_blank"><img src="static/demo/evid_c.png" style="width: 100px;"></a> | <a href="static/demo/evid_d.png" target="_blank"><img src="static/demo/evid_d.png" style="width: 100px;"></a> |

| EvidÃªncia E (CSV) | EvidÃªncia E (Print) | EvidÃªncia F | EvidÃªncia G |
|-------------------|---------------------|-------------|-------------|
| <a href="static/demo/evid_e.csv" target="_blank">EvidÃªncia E (CSV)</a> | <a href="static/demo/evid_e.png" target="_blank"><img src="static/demo/evid_e.png" style="width: 100px;"></a> | <a href="static/demo/evid_f.png" target="_blank"><img src="static/demo/evid_f.png" style="width: 100px;"></a> | <a href="static/demo/evid_g.png" target="_blank"><img src="static/demo/evid_g.png" style="width: 100px;"></a> |

| EvidÃªncia H | EvidÃªncia I |
|-------------|-------------|
| <a href="static/demo/evid_h.png" target="_blank"><img src="static/demo/evid_h.png" style="width: 100px;"></a> | <a href="static/demo/evid_i.png" target="_blank"><img src="static/demo/evid_i.png" style="width: 100px;"></a> |

</div>

<div align="center">

### ğŸŒ Esquema do geral do banco de dados

**Acesse a documentaÃ§Ã£o completa e demonstraÃ§Ãµes:**  
ğŸ”— [https://sertan-ai.github.io/documentacao-ss-camada1](https://sertan-ai.github.io/documentacao-ss-camada1)

</div>

---

### ğŸ”’ Limites Confirmados

- [X] NDVI nÃ£o Ã© persistido pela Camada 1
- [X] PrecipitaÃ§Ã£o nÃ£o Ã© persistida pela Camada 1
- [X] Fotos nÃ£o sÃ£o interpretadas no MVP
- [X] Nenhuma inferÃªncia ocorre antes do trigger oficial
- [X] O design final do relatÃ³rio ainda nÃ£o estÃ¡ definido; o design atual Ã© uma prova de conceito

---

## ğŸ“Œ Status Final

<div align="center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; margin: 20px 0;">

### ğŸ“‹ Contrato de Dados (V0)

**Status:** â³ **Aguardando aceite**

**ResponsÃ¡vel pela validaÃ§Ã£o:** Samuel Santos (Camada 1)  
**Consumidores dependentes:** Silvio / Nilo / Camada 2

---

<table style="width: 100%; background: rgba(255,255,255,0.2); border-radius: 10px; margin-top: 20px;">
<tr>
<td align="center" style="padding: 15px;">
<strong>Data de criaÃ§Ã£o:</strong><br>
Dezembro 2025
</td>
<td align="center" style="padding: 15px;">
<strong>Ãšltima atualizaÃ§Ã£o:</strong><br>
V0 - 2025
</td>
<td align="center" style="padding: 15px;">
<strong>PrÃ³xima revisÃ£o:</strong><br>
ApÃ³s aceite da Camada 2
</td>
</tr>
</table>

</div>

---

<div align="center">

*Documento tÃ©cnico â€¢ Sertan AI â€¢ Camada 1 â€” Monitoramento de Campo*

[![GitHub](https://img.shields.io/badge/GitHub-DocumentaÃ§Ã£o-blue?style=for-the-badge&logo=github)](https://github.com/Sertan-AI/documentacao-ss-camada1)

</div>
